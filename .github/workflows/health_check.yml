name: Workflow Health Check

on:
  schedule:
    # 매일 09:00 KST (00:00 UTC)에 실행
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check last update time
        run: |
          # news_monitor.csv의 최종 수정 시간 확인
          if [ -f "data/news_monitor.csv" ]; then
            last_modified=$(git log -1 --format=%cd --date=iso data/news_monitor.csv)
            echo "Last update: $last_modified"

            # 24시간 이상 업데이트 없으면 경고
            last_commit_timestamp=$(git log -1 --format=%ct data/news_monitor.csv)
            current_timestamp=$(date +%s)
            time_diff=$((current_timestamp - last_commit_timestamp))
            hours_since_update=$((time_diff / 3600))

            echo "Hours since last update: $hours_since_update"

            if [ $hours_since_update -gt 24 ]; then
              echo "⚠️ WARNING: No updates for $hours_since_update hours!"
              echo "GitHub Actions may be disabled. Please check:"
              echo "https://github.com/${{ github.repository }}/actions"
              exit 1
            else
              echo "✅ System is healthy. Last update: $hours_since_update hours ago"
            fi
          else
            echo "❌ ERROR: news_monitor.csv not found!"
            exit 1
          fi

      - name: Send health check notification
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=⚠️ GitHub Actions Health Check Failed!%0A%0ANews monitoring may be down. Please check:%0Ahttps://github.com/${{ github.repository }}/actions" \
              -d "parse_mode=HTML"
          fi
