name: System Health Check

on:
  schedule:
    # ë§¤ì¼ 09:00 KST (00:00 UTC)ì— ì‹¤í–‰
    - cron: '0 0 * * *'
    # ì¶”ê°€: ë§¤ì¼ 21:00 KST (12:00 UTC)ì—ë„ ì‹¤í–‰ (í•˜ë£¨ 2íšŒ)
    - cron: '0 12 * * *'
  workflow_dispatch:

permissions:
  contents: write  # ìƒíƒœ íŒŒì¼ ì»¤ë°‹ì„ ìœ„í•´ write ê¶Œí•œ í•„ìš”

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Comprehensive Health Check
        id: health
        run: |
          echo "ğŸ” System Health Check Starting..."
          echo "=========================================="

          ISSUES=""
          WARNINGS=""
          STATUS="healthy"

          # 1. ë‰´ìŠ¤ DB ìµœì¢… ì—…ë°ì´íŠ¸ ì‹œê°„ í™•ì¸
          if [ -f "data/news_monitor.csv" ]; then
            last_commit_timestamp=$(git log -1 --format=%ct data/news_monitor.csv)
            current_timestamp=$(date +%s)
            time_diff=$((current_timestamp - last_commit_timestamp))
            hours_since_update=$((time_diff / 3600))

            echo "ğŸ“Š News DB: Last update $hours_since_update hours ago"

            if [ $hours_since_update -gt 24 ]; then
              ISSUES="${ISSUES}âŒ No DB updates for $hours_since_update hours\n"
              STATUS="critical"
            elif [ $hours_since_update -gt 6 ]; then
              WARNINGS="${WARNINGS}âš ï¸ DB not updated for $hours_since_update hours\n"
              STATUS="warning"
            fi
          else
            ISSUES="${ISSUES}âŒ news_monitor.csv not found\n"
            STATUS="critical"
          fi

          # 2. ìºì‹œ íŒŒì¼ í™•ì¸
          if [ -f "data/sent_articles_cache.json" ]; then
            cache_size=$(wc -c < "data/sent_articles_cache.json")
            echo "ğŸ“¦ Cache file: ${cache_size} bytes"

            if [ $cache_size -lt 100 ]; then
              WARNINGS="${WARNINGS}âš ï¸ Cache file suspiciously small\n"
              STATUS="warning"
            fi
          else
            WARNINGS="${WARNINGS}âš ï¸ Cache file missing (will be recreated)\n"
          fi

          # 3. API ì‚¬ìš©ëŸ‰ í™•ì¸
          if [ -f "data/api_usage.json" ]; then
            echo "ğŸ“ˆ API usage file exists"
          else
            echo "â„¹ï¸ API usage file not found (normal for first run)"
          fi

          # 4. GitHub Actions ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì´ë ¥ í™•ì¸
          echo "ğŸ”„ Checking recent workflow runs..."

          # 5. ì‹œìŠ¤í…œ ìƒíƒœ ì¶œë ¥
          echo ""
          echo "=========================================="
          if [ "$STATUS" = "healthy" ]; then
            echo "âœ… System Status: HEALTHY"
          elif [ "$STATUS" = "warning" ]; then
            echo "âš ï¸ System Status: WARNING"
          else
            echo "âŒ System Status: CRITICAL"
          fi
          echo "=========================================="

          # í™˜ê²½ ë³€ìˆ˜ë¡œ ê²°ê³¼ ì „ë‹¬
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "issues<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "warnings<<EOF" >> $GITHUB_OUTPUT
          echo -e "$WARNINGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Critical ìƒíƒœë©´ ì‹¤íŒ¨ ì²˜ë¦¬
          if [ "$STATUS" = "critical" ]; then
            exit 1
          fi

      - name: Create system status file
        if: always()
        run: |
          mkdir -p data
          cat > data/system_status.json <<EOF
          {
            "last_check": "$(date -u +'%Y-%m-%d %H:%M:%S UTC')",
            "status": "${{ steps.health.outputs.status }}",
            "checks": {
              "news_db_updated": $([ -f "data/news_monitor.csv" ] && echo "true" || echo "false"),
              "cache_exists": $([ -f "data/sent_articles_cache.json" ] && echo "true" || echo "false"),
              "api_usage_tracked": $([ -f "data/api_usage.json" ] && echo "true" || echo "false")
            }
          }
          EOF

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/system_status.json
          git commit -m "Update system status - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "No changes"
          git push || echo "Push failed (non-critical)"

      - name: Send critical alert
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="ğŸš¨ *ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨*%0A%0A"
          MESSAGE="${MESSAGE}ë‰´ìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.%0A%0A"
          MESSAGE="${MESSAGE}*ë¬¸ì œì :*%0A${{ steps.health.outputs.issues }}%0A"
          MESSAGE="${MESSAGE}í™•ì¸ í•„ìš”: https://github.com/${{ github.repository }}/actions"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"

      - name: Send warning alert
        if: success() && steps.health.outputs.status == 'warning'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="âš ï¸ *ì‹œìŠ¤í…œ ê²½ê³ *%0A%0A"
          MESSAGE="${MESSAGE}${{ steps.health.outputs.warnings }}%0A"
          MESSAGE="${MESSAGE}ëª¨ë‹ˆí„°ë§ ì¤‘: https://github.com/${{ github.repository }}/actions"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"
